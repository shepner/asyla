# Cloudflare Tunnel (cloudflared) for d01
# Provides internet access to d01 applications via Cloudflare Tunnel
#
# Setup:
# 1. Create tunnel in Cloudflare Zero Trust dashboard, get TUNNEL_TOKEN
# 2. Set TUNNEL_TOKEN in ~/scripts/d01/apps/cloudflared/.env (copy from .env.example)
# 3. Add app networks to the networks list below as apps are added
# 4. Configure Public Hostnames in Cloudflare dashboard

services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-d01
    restart: unless-stopped
    # Token mode (from setup-tunnel-api.py or dashboard): config is remote
    command: ["tunnel", "run", "--token", "${TUNNEL_TOKEN}"]
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    # Attach to app networks so tunnel can reach services
    networks:
      - d01_internal
      - media_net
      - calibre_net
      - homebridge_net

networks:
  d01_internal:
    external: true
    name: d01_internal
  media_net:
    external: true
    name: media_net
  calibre_net:
    external: true
    name: calibre_net
  homebridge_net:
    external: true
    name: homebridge_net
