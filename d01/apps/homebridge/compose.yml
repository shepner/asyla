# Homebridge on d01. Uses host network for mDNS/HomeKit; proxy container exposes UI to tunnel.
# Run: ~/scripts/d01/apps/homebridge/homebridge.sh up
# Ref: https://github.com/homebridge/homebridge/wiki/Install-Homebridge-on-Docker

networks:
  homebridge_net:
    external: true
    name: homebridge_net

services:
  homebridge:
    image: homebridge/homebridge:latest
    container_name: homebridge
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=${LOCAL_TZ:-America/Chicago}
      - ENABLE_AVAHI=1
    volumes:
      - .:/homebridge
    # No networks: host mode. Homebridge UI on host:8581, Camera UI on host:8181.

  # Proxy: Homebridge UI (host:8581) for hostname homebridge.
  homebridge-proxy:
    image: caddy:alpine
    container_name: homebridge-proxy
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["caddy", "reverse-proxy", "--from", ":8581", "--to", "http://host.docker.internal:8581"]
    networks:
      - homebridge_net

  # Proxy: Camera UI (host:8181) for hostname cameraui.
  cameraui-proxy:
    image: caddy:alpine
    container_name: cameraui-proxy
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["caddy", "reverse-proxy", "--from", ":8181", "--to", "http://host.docker.internal:8181"]
    networks:
      - homebridge_net
